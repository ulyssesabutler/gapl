# simtest

A Gradle stage to validate Verilog generated by the GAPL compiler using Verilator.

Two phases:
1) simtestCompile: Lint/compile generated Verilog with Verilator and fail on errors.
2) simtestRun: Build each test's Verilator C++ harness and run it, failing if the program exits non-zero.

Test structure:
- Place each test in its own subdirectory under simtest/tests, e.g. simtest/tests/my_test.
- In each test directory:
  - One or more .gapl files that will be compiled to Verilog.
  - One or more C++ wrapper files (*.cpp) that drive the simulation (e.g., a main that instantiates and stimulates the model).
  - Optional: top.txt containing the top module name if it can't be inferred.

Top module inference order:
1) tests/<name>/top.txt content (first line, trimmed).
2) If exactly one .gapl file is present: use its basename as the top module name.
3) Parse the C++ wrapper for an include of V<top>.h.

Generated artifacts:
- Verilog: build/tests/<test>/verilog/*.v
- Verilator obj_dir and executable: build/tests/<test>/obj_dir/sim_<test>

Tasks:
- simtestGenerateVerilog: Compile GAPL to Verilog for all test directories.
- simtestCompile: Lint/compile Verilog with Verilator (depends on simtestGenerateVerilog).
- simtestRun: Build and run all eligible tests (depends on simtestGenerateVerilog).
- build: Depends on simtestCompile and simtestRun.

Requirements:
- Verilator installed and on your PATH (verilator --version should work).
- The :compiler project must be buildable; simtest depends on :compiler:installDist.

Adding new tests:
- Create a new directory under simtest/tests, e.g., simtest/tests/fifo.
- Add fifo.gapl and a C++ file like sim_main.cpp that runs the test.
- Optionally add simtest/tests/fifo/top.txt with "fifo" if top module name can't be inferred.
- Run: ./gradlew :simtest:build
